<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estimate | TAmJ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;family=Noto+Sans+JP:wght@200;300;400;500;700&amp;family=Noto+Serif+JP:wght@200;300;400;500;600&amp;display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/corporate.css">
    <link rel="stylesheet" href="../css/tools.css">
    <style>
        .preview-overlay{display:none;position:fixed;inset:0;z-index:3000;background:rgba(12,12,12,.88);backdrop-filter:blur(6px);overflow-y:auto;padding:2rem}
        .preview-overlay.show{display:flex;justify-content:center;align-items:flex-start}
        .preview-panel{background:#fff;width:100%;max-width:860px;margin:2rem auto;position:relative}
        .preview-head{background:var(--charcoal);color:#fff;padding:1.5rem 2rem;display:flex;justify-content:space-between;align-items:center}
        .preview-head h2{font-family:var(--font-serif);font-size:1.1rem;font-weight:400;letter-spacing:.04em;margin:0}
        .preview-close{background:none;border:none;color:rgba(255,255,255,.6);font-size:1.5rem;cursor:pointer;padding:0 .5rem;transition:color .3s}
        .preview-close:hover{color:#fff}
        .preview-body{padding:2rem}
        .preview-actions{display:flex;gap:8px;padding:1rem 2rem;background:var(--cream);border-top:1px solid var(--gray-200)}
        .preview-actions .btn{padding:.6rem 1.2rem;font-size:.75rem;font-weight:600;letter-spacing:.5px;border:none;cursor:pointer;transition:all .3s}
        .preview-actions .btn.primary{background:var(--charcoal);color:#fff}
        .preview-actions .btn.primary:hover{background:var(--primary)}
        .preview-actions .btn.secondary{background:#fff;color:var(--charcoal);border:1px solid var(--gray-300)}
        .preview-actions .btn.secondary:hover{border-color:var(--charcoal)}
        .pv-section{margin-bottom:1.5rem}
        .pv-section-title{font-size:.8rem;font-weight:700;color:var(--charcoal);letter-spacing:.03em;padding:.5rem 0;border-bottom:2px solid var(--charcoal);margin-bottom:.5rem}
        .pv-table{width:100%;border-collapse:collapse;font-size:.78rem}
        .pv-table th{text-align:left;padding:.5rem .6rem;background:var(--cream);color:var(--charcoal);font-weight:600;font-size:.7rem;letter-spacing:.02em;border-bottom:1px solid var(--gray-200)}
        .pv-table td{padding:.45rem .6rem;border-bottom:1px solid var(--gray-100);color:var(--gray-500)}
        .pv-table td:nth-child(n+2){text-align:right;font-family:var(--font-display);font-weight:500;color:var(--charcoal);font-variant-numeric:tabular-nums}
        .pv-table tr.subtotal td{font-weight:700;color:var(--charcoal);border-bottom:2px solid var(--gray-300);background:var(--cream)}
        .pv-note{font-size:.7rem;color:var(--gray-400);line-height:1.7;margin-top:.8rem;padding:.6rem;background:var(--cream);border-left:3px solid var(--gray-300)}
        .pv-badge{display:inline-block;padding:.15rem .5rem;font-size:.6rem;font-weight:700;letter-spacing:1px;margin-left:.5rem}
        .pv-badge.on{background:var(--charcoal);color:#fff}
        .pv-badge.off{background:var(--cream);color:var(--charcoal);border:1px solid var(--gray-300)}
        .pv-badge.check{background:var(--primary);color:#fff}
        .pv-meta{display:flex;gap:1.5rem;flex-wrap:wrap;font-size:.72rem;color:var(--gray-400);margin-bottom:1rem}
        .pv-compare{display:grid;grid-template-columns:1fr 1fr;gap:0;border:1px solid var(--gray-200);margin-top:.5rem}
        .pv-compare-head{background:var(--charcoal);color:#fff;padding:.4rem .6rem;font-size:.7rem;font-weight:600;text-align:center}
        .pv-compare-cell{padding:.4rem .6rem;font-size:.72rem;border-bottom:1px solid var(--gray-100)}
        .pv-compare-cell:nth-child(even){border-left:1px solid var(--gray-200)}
        @media print{
            /* When a preview panel is open: hide everything else */
            body.preview-open>*:not(.preview-overlay){display:none!important}
            body.preview-open .preview-overlay:not(.show){display:none!important}
            body.preview-open .preview-overlay.show{display:block!important;position:static;background:#fff;padding:0;overflow:visible}
            .preview-panel{box-shadow:none;max-width:100%}
            .preview-head{background:#fff!important;color:#2d2d2d!important;border-bottom:3px solid #2d2d2d!important;padding:1.5rem 2rem!important}
            .preview-head h2{color:#2d2d2d!important}
            .preview-actions,.preview-close{display:none!important}
            .pv-badge,.pv-compare-head,.pv-section-title{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;color-adjust:exact!important}
            .pv-badge.on{background:#fff!important;color:#2d2d2d!important;border:2px solid #2d2d2d!important}
            .pv-badge.check{background:#fff!important;color:#C8161D!important;border:2px solid #C8161D!important}
            .pv-badge.off{background:#fff!important;color:#999!important;border:1px solid #999!important}
            .pv-compare-head{background:#fff!important;color:#2d2d2d!important;border:1px solid #2d2d2d!important;font-weight:700!important}
            .pv-section-title{border-bottom:2px solid #2d2d2d!important}
            .pv-section{break-inside:avoid}
            /* When no preview: normal estimate print */
            body:not(.preview-open) header,
            body:not(.preview-open) footer,
            body:not(.preview-open) .corp-back,
            body:not(.preview-open) .preview-overlay{display:none!important}
        }
    </style>
</head>
<body>
<a class="corp-back" href="https://tamjump.github.io/TAmj/index.html"><span class="arr">&larr;</span> TAmJ.Corp</a>
    <header id="siteHeader">
        <a href="../index.html" class="header-logo"><img src="../logo.png" alt="TAmJ"></a>
        <nav class="header-nav">
            <a href="../index.html">Top</a>
            <a href="../pricing.html">Pricing</a>
            <a href="index.html">MyPage</a>
            <a href="../contact.html" class="nav-cta">Contact</a>
        </nav>
    </header>

    <div class="page-header">
        <span class="member-badge">DEVELOPMENT × FINANCIAL DESIGN</span>
        <h1>開発シミュレーション 詳細見積</h1>
        <p style="font-size:.82rem;color:rgba(255,255,255,.55);margin-top:.5rem;letter-spacing:.03em">本資料は建設見積ではなく「開発×財務設計」の統合提案です</p>
        <p id="headerTimestamp" style="font-size:.7rem;color:rgba(255,255,255,.35);margin-top:.3rem">作成日時: -</p>
    </div>
    <main class="main-container">
        <div class="estimate-grid" id="estimateContent"></div>
    </main>

    <!-- BS影響概算表 プレビュー -->
    <div class="preview-overlay" id="bsPreview">
        <div class="preview-panel">
            <div class="preview-head"><h2>BS影響概算表 ─ 財務設計資料</h2><button class="preview-close" onclick="closePreview('bsPreview')">&times;</button></div>
            <div class="preview-body" id="bsPreviewBody"></div>
            <div class="preview-actions">
                <button class="btn primary" onclick="printPreview('bsPreview')">PDF保存（印刷）</button>
                <button class="btn secondary" onclick="downloadBSCSV()">CSV出力</button>
                <button class="btn secondary" onclick="closePreview('bsPreview')">閉じる</button>
            </div>
        </div>
    </div>

    <!-- リース仕訳シート プレビュー -->
    <div class="preview-overlay" id="leasePreview">
        <div class="preview-panel">
            <div class="preview-head"><h2>リース会計設計 ─ 財務設計資料</h2><button class="preview-close" onclick="closePreview('leasePreview')">&times;</button></div>
            <div class="preview-body" id="leasePreviewBody"></div>
            <div class="preview-actions">
                <button class="btn primary" onclick="printPreview('leasePreview')">PDF保存（印刷）</button>
                <button class="btn secondary" onclick="downloadLeaseCSV()">CSV出力</button>
                <button class="btn secondary" onclick="closePreview('leasePreview')">閉じる</button>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-inner">
            <div class="footer-brand"><img src="../logo.png" alt="TAmJ"><p>Touch all minds, Jump</p></div>
            <div class="footer-links">
                <div class="footer-col"><h4>Account</h4><a href="../register.html">会員登録</a><a href="index.html">会員ページ</a></div>
                <div class="footer-col"><h4>Support</h4><a href="https://tamjump.github.io/TAmj/contact.html">お問合せ</a></div>
            </div>
        </div>
        <div class="footer-bottom"><p class="footer-copy">&copy; 2025 TAmJ株式会社 All Rights Reserved.</p></div>
    </footer>

    <script>
        const _h=document.getElementById('siteHeader');
        if(_h) window.addEventListener('scroll',()=>_h.classList.toggle('scrolled',window.scrollY>50));
    </script>
    <script>
        const facilityNames={tokuyo:'特養',yuryo:'有料老人ホーム',sakouju:'サ高住',groupHome:'グループホーム'};
        function yen(n){return"¥"+Math.round(Number(n||0)).toLocaleString("ja-JP")}
        function yenShort(n){n=Number(n||0);if(n>=1e8)return"¥"+(n/1e8).toFixed(2)+"億";if(n>=1e4)return"¥"+Math.round(n/1e4).toLocaleString()+"万";return yen(n)}
        function yenRange(a,b){return yenShort(a)+"〜"+yenShort(b)}
        function formatDate(iso){const d=new Date(iso);return d.toLocaleDateString('ja-JP')+' '+d.toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'})}

        // 2025-2026 関東ゼネコン実勢ベース
        const A_BREAKDOWN_RATIOS=[
            {category:'仮設工事',ratio:.05,items:[{name:'共通仮設',ratio:.35,note:'仮囲い、仮設電気水道等'},{name:'直接仮設',ratio:.65,note:'足場、養生、安全設備'}]},
            {category:'土工事',ratio:.04,items:[{name:'掘削・埋戻し',ratio:.70,note:'根切り、埋戻し、残土処分'},{name:'地業',ratio:.30,note:'砕石地業、転圧'}]},
            {category:'躯体工事',ratio:.22,items:[{name:'基礎',ratio:.30,note:'基礎コンクリート、型枠、配筋'},{name:'構造躯体',ratio:.70,note:'柱・梁・床・壁（RC/S）'}]},
            {category:'防水工事',ratio:.03,items:[{name:'屋上防水',ratio:.70,note:'屋上・バルコニー防水'},{name:'浴室防水',ratio:.30,note:'浴室・機械浴室床防水'}]},
            {category:'外装工事',ratio:.09,items:[{name:'外壁',ratio:.65,note:'外壁仕上（ALC・タイル等）'},{name:'開口部',ratio:.35,note:'サッシ、自動ドア'}]},
            {category:'内装工事',ratio:.12,items:[{name:'共用部仕上',ratio:.25,note:'廊下・ホール床壁天井'},{name:'居室仕上',ratio:.35,note:'居室床・壁・天井'},{name:'建具',ratio:.25,note:'居室扉、共用部建具'},{name:'造作',ratio:.15,note:'収納、カウンター等'}]},
            {category:'給排水衛生設備',ratio:.13,items:[{name:'給水・給湯',ratio:.25,note:'受水槽、ポンプ、給湯器'},{name:'排水',ratio:.15,note:'汚水・雑排水配管'},{name:'衛生器具',ratio:.35,note:'全居室トイレ・洗面'},{name:'浴室設備',ratio:.25,note:'一般浴、機械浴槽'}]},
            {category:'空調換気設備',ratio:.12,items:[{name:'空調機器',ratio:.50,note:'全居室エアコン、共用部空調'},{name:'室外機・冷媒配管',ratio:.30,note:'屋上室外機、冷媒・ドレン'},{name:'換気設備',ratio:.20,note:'24時間換気、浴室・厨房換気'}]},
            {category:'電気設備',ratio:.12,items:[{name:'受変電・幹線',ratio:.30,note:'キュービクル、幹線ケーブル'},{name:'照明・コンセント',ratio:.25,note:'LED照明、コンセント系統'},{name:'弱電・通信',ratio:.25,note:'ナースコール、LAN、放送'},{name:'防災設備',ratio:.20,note:'自火報、スプリンクラー、誘導灯'}]},
            {category:'外構工事',ratio:.04,items:[{name:'アプローチ',ratio:.50,note:'玄関アプローチ、スロープ'},{name:'駐車場・植栽',ratio:.30,note:'舗装、ライン、植栽'},{name:'外部設備',ratio:.20,note:'外部給排水、外灯、手摺'}]},
            {category:'諸経費・共通費',ratio:.04,items:[{name:'現場管理費',ratio:.60,note:'現場代理人、安全管理'},{name:'一般管理費',ratio:.40,note:'本社経費、保険等'}]}
        ];
        const B_BREAKDOWN=[
            {name:'サイン・看板',note:'館内サイン、案内板、外部看板',unitPrice:800000},
            {name:'防犯・監視カメラ',note:'監視カメラ、NVR、入退室管理',perRoom:45000},
            {name:'ネットワーク・Wi-Fi',note:'LAN配線、Wi-Fi AP、サーバーラック',perRoom:18000},
            {name:'カーテンレール・ブラインド',note:'居室カーテンレール、共用部ブラインド',perRoom:12000},
            {name:'ナースコール増設',note:'浴室・トイレ呼出、ペンダント等',perRoom:15000}
        ];

        function getSimData(){
            const raw=localStorage.getItem('devSimulation');
            if(!raw)return null;
            const data=JSON.parse(raw);
            const fac=data.facility||{},inp=data.inputs||{},comp=data.computed||{},land=inp.land||{};
            const buildMin=comp.build?.min||0,buildMax=comp.build?.max||0,buildMid=(buildMin+buildMax)/2;
            const totalMid=((comp.summary?.totalMin||0)+(comp.summary?.totalMax||0))/2;
            const isPurchase=land.mode==='purchase',taxRate=(inp.taxRate||10)/100;
            return{data,fac,inp,comp,land,buildMin,buildMax,buildMid,totalMid,isPurchase,taxRate,residents:fac.residents||50,gfa:inp.gfa_m2||1};
        }

        function generateBreakdownTable(bm,res,gfa){
            let h='<table class="breakdown-table"><tr><th>工事項目</th><th>内容</th><th>金額（税抜）</th></tr>';
            let tA=0;
            A_BREAKDOWN_RATIOS.forEach(c=>{const ct=bm*c.ratio;tA+=ct;h+=`<tr class="category"><td colspan="2">${c.category}</td><td>${yen(ct)}</td></tr>`;c.items.forEach(i=>h+=`<tr><td class="sub-item">${i.name}</td><td class="note">${i.note}</td><td>${yen(ct*i.ratio)}</td></tr>`)});
            h+=`<tr class="subtotal"><td colspan="2">A工事 小計</td><td>${yen(tA)}</td></tr>`;
            let tB=0;h+=`<tr class="category"><td colspan="3" style="background:var(--t-bg-alt);color:var(--primary);">B工事（付帯工事）</td></tr>`;
            B_BREAKDOWN.forEach(i=>{let c=i.unitPrice||0;if(i.perRoom)c=i.perRoom*res;tB+=c;h+=`<tr><td class="sub-item">${i.name}</td><td class="note">${i.note}</td><td>${yen(c)}</td></tr>`});
            h+=`<tr class="subtotal"><td colspan="2">B工事 小計</td><td>${yen(tB)}</td></tr>`;
            h+=`<tr class="total"><td colspan="2">A+B工事 合計（税抜）</td><td>${yen(tA+tB)}</td></tr></table>`;
            h+=`<div style="margin-top:.8rem;padding:.6rem;background:#fff;font-size:.7rem;color:var(--gray-500)"><div style="display:flex;gap:1rem;flex-wrap:wrap"><span>㎡単価: <b style="color:var(--charcoal)">${yen(bm/gfa)}/㎡</b></span><span>坪単価: <b style="color:var(--charcoal)">${yen(bm/gfa*3.3)}/坪</b></span><span>延床: <b style="color:var(--charcoal)">${gfa.toLocaleString()}㎡</b></span></div></div>`;
            return h;
        }

        // ══ メイン見積 ══
        function render(){
            const el=document.getElementById('estimateContent');
            const s=getSimData();
            if(!s){el.innerHTML='<div class="empty-state"><h2>シミュレーションデータがありません</h2><p>開発シミュレーションページで条件を入力してください。</p><a href="service-development.html" class="btn primary" style="display:inline-block;padding:.8rem 1.5rem">シミュレーションへ</a></div>';return;}
            const{data,fac,inp,comp,land,buildMin,buildMax,buildMid,residents,gfa}=s;
            document.getElementById('headerTimestamp').textContent='作成日時: '+formatDate(data.savedAt);
            const tasks=data.selectedTasks||[];
            const landMode=land.mode==='lease'?'借地':'購入';
            const tlf=(land.auto==='auto'?(land.landFees_auto_net||0):0)+(land.landFees_manual_net||0);
            el.innerHTML=`
            <div class="estimate-main">
                <div class="card"><h2><span class="icon">0</span> 施設計画</h2>
                    <div class="data-row"><span class="label">施設種別</span><span class="value">${facilityNames[fac.facilityType]||fac.facilityType||'-'}</span></div>
                    <div class="data-row"><span class="label">入居者数</span><span class="value">${residents} 人</span></div>
                    <div class="data-row"><span class="label">個室面積</span><span class="value">${fac.privateArea||0} ㎡/室</span></div>
                    <div class="data-row"><span class="label">レンタブル比</span><span class="value">${fac.rentableRatio||0}%</span></div></div>
                <div class="card"><h2><span class="icon">1</span> 建築条件</h2>
                    <div class="data-row"><span class="label">都道府県</span><span class="value">${inp.pref||'-'}</span></div>
                    <div class="data-row"><span class="label">構造</span><span class="value">${inp.structure||'-'}</span></div>
                    <div class="data-row"><span class="label">階数</span><span class="value">${inp.floors||2} 階</span></div>
                    <div class="data-row"><span class="label">延床面積</span><span class="value">${(inp.gfa_m2||0).toLocaleString()} ㎡</span></div>
                    <div class="data-row"><span class="label">用途係数 / 指数</span><span class="value">×${inp.useFactor||1.25} / ×${inp.indexFactor||1.10}</span></div>
                    ${comp.marketIndex?.enabled?`<div class="data-row"><span class="label">MCI（市場連動指数）</span><span class="value" style="color:var(--primary)">MCI ${(1+(comp.marketIndex.mci-1)*(comp.marketIndex.smoothing||0.6)).toFixed(4)} ／ Building ×${(1+(comp.marketIndex.building-1)*(comp.marketIndex.smoothing||0.6)).toFixed(3)} ／ MEP ×${(1+(comp.marketIndex.mep-1)*(comp.marketIndex.smoothing||0.6)).toFixed(3)}</span></div>`:''}</div>
                <div class="card"><h2><span class="icon">2</span> 土地・仕入</h2>
                    <div class="data-row"><span class="label">土地形態</span><span class="value">${landMode}</span></div>
                    ${land.mode==='purchase'?`<div class="data-row"><span class="label">土地仕入価格</span><span class="value">${yenShort(land.land_price||0)}</span></div>`:`<div class="data-row"><span class="label">月額地代</span><span class="value">${yenShort(land.ground_rent_month||0)}/月</span></div>`}
                    <div class="data-row"><span class="label">土地関連諸費用</span><span class="value">${yenShort(tlf)}</span></div></div>
                <div class="card"><h2><span class="icon">3</span> 建築費（A+B工事）内訳 <span class="section-badge">税抜</span></h2>
                    <div class="data-row highlight"><span class="label">建築費概算</span><span class="value">${yenRange(buildMin,buildMax)}</span></div>
                    ${generateBreakdownTable(buildMid,residents,gfa)}</div>
                <div class="card"><h2><span class="icon">4</span> その他費用</h2>
                    <div class="data-row"><span class="label">開発作業費</span><span class="value">${yenRange(comp.devTasksCost?.min||0,comp.devTasksCost?.max||0)}</span></div>
                    <div class="data-row highlight"><span class="label">投資総額（税込概算）</span><span class="value">${yenRange(comp.summary?.totalMin||0,comp.summary?.totalMax||0)}</span></div></div>
                <div class="card"><h2><span class="icon">5</span> 選択した開発作業</h2>
                    ${tasks.length>0?`<div class="task-list">${tasks.map(t=>`<span class="task-tag"><span class="phase">${t.split('-')[0]}</span>${t}</span>`).join('')}</div>`:'<p style="color:var(--gray-500);font-size:.8rem">選択なし</p>'}</div>
                <div class="card"><h2><span class="icon">6</span> 収支</h2>
                    <div class="data-row"><span class="label">年間収入</span><span class="value">${yenShort(comp.summary?.incomeY||0)}</span></div>
                    <div class="data-row highlight"><span class="label">年間NOI</span><span class="value">${yenShort(comp.summary?.noiY||0)}</span></div></div>
            </div>
            <div class="summary-sidebar">
                <div class="summary-card">
                    <h3>見積サマリー</h3>
                    <div class="summary-section"><div class="summary-label">施設種別</div><div class="summary-value" style="font-size:.85rem">${facilityNames[fac.facilityType]||'-'} / ${residents}人</div></div>
                    <div class="summary-section"><div class="summary-label">投資総額（概算）</div><div class="summary-value">${yenShort(((comp.summary?.totalMin||0)+(comp.summary?.totalMax||0))/2)}</div></div>
                    <div class="summary-section"><div class="summary-label">年間NOI</div><div class="summary-value">${yenShort(comp.summary?.noiY||0)}</div></div>
                    <div class="yield-box">
                        <div class="label">NOI利回り</div>
                        <div class="value">${(comp.summary?.noiYield||0).toFixed(2)}%</div>
                        <div class="yield-sub"><span>表面: ${(comp.summary?.grossYield||0).toFixed(1)}%</span><span>回収: ${comp.summary?.noiY>0?(((comp.summary?.totalMin||0)+(comp.summary?.totalMax||0))/2/comp.summary?.noiY).toFixed(1):'-'}年</span></div>
                    </div>
                    <div style="padding:.8rem;background:var(--cream);margin:.8rem 0;font-size:.72rem;line-height:1.8;color:var(--charcoal)">
                        <div style="font-weight:700;margin-bottom:.3rem;font-size:.68rem;letter-spacing:1px;color:var(--gray-400)">BANK METRICS</div>
                        <div style="display:flex;justify-content:space-between"><span>LTV</span><b>75%</b></div>
                        <div style="display:flex;justify-content:space-between"><span>DSCR</span><b>${comp.summary?.noiY>0?(comp.summary.noiY/(((comp.summary?.totalMin||0)+(comp.summary?.totalMax||0))/2*0.75*0.02+((comp.summary?.totalMin||0)+(comp.summary?.totalMax||0))/2*0.75/25)).toFixed(1)+'倍':'-'}</b></div>
                        <div style="display:flex;justify-content:space-between"><span>年間返済額（概算）</span><b>${yenShort(((comp.summary?.totalMin||0)+(comp.summary?.totalMax||0))/2*0.75*0.02+((comp.summary?.totalMin||0)+(comp.summary?.totalMax||0))/2*0.75/25)}</b></div>
                    </div>
                    <div class="summary-actions">
                        <button class="btn primary" onclick="printEstimateDev()">印刷 / PDF保存</button>
                        <button class="btn secondary" onclick="openBSPreview()">BS影響概算表</button>
                        <button class="btn secondary" onclick="openLeasePreview()">リース会計設計</button>
                        <button class="btn secondary" onclick="openEquipDetail()">建物設備明細</button>
                        <button class="btn secondary" onclick="openMCIReport()" style="border-color:var(--primary);color:var(--primary);font-weight:600">マクロ建築指数</button>
                    </div>
                </div>
                <div class="notes-card" style="border:1px solid var(--gray-200)">
                    <div style="font-size:.68rem;letter-spacing:1px;color:var(--gray-400);font-weight:600;margin-bottom:.5rem">FINANCIAL DESIGN</div>
                    <p style="font-size:.75rem;color:var(--charcoal);line-height:1.8;margin:0 0 .8rem">本開発は <b>オンバランス型・オフバランス型・SPC分離型</b> いずれの財務設計にも対応可能です。</p>
                    <p style="font-size:.7rem;color:var(--gray-400);line-height:1.7;margin:0">最終判断は貴社顧問税理士・金融機関と協議の上決定します。</p>
                </div>
                <div class="notes-card"><h4>ご注意</h4><ul><li>本見積は概算シミュレーションです</li><li>A工事単価ベース（動産除外）</li><li>B工事は付帯工事の参考値</li><li>C工事（什器備品）は別途</li><li>正式見積はヒアリング後に作成</li></ul></div>
            </div>`;
        }

        // ══ 用語解説（BS・リース共通） ══
        function glossaryHTML(){
            return `<div class="pv-section" style="margin-top:2rem;border-top:2px solid var(--gray-200);padding-top:1.5rem">
            <div class="pv-section-title">用語解説</div>
            <table class="pv-table" style="table-layout:fixed">
            <tr><th style="width:22%">用語</th><th style="text-align:left">解説</th></tr>
            <tr><td><b>BS（貸借対照表）</b></td><td style="text-align:left">企業の資産・負債・純資産を一覧にした財務諸表。Balance Sheet の略。</td></tr>
            <tr><td><b>PL（損益計算書）</b></td><td style="text-align:left">一定期間の収益・費用・利益を示す財務諸表。Profit & Loss の略。</td></tr>
            <tr><td><b>オンバランス</b></td><td style="text-align:left">資産・負債をBSに計上すること。銀行評価では担保化でき、融資に有利。</td></tr>
            <tr><td><b>オフバランス</b></td><td style="text-align:left">BSに計上しない処理。BSが軽くなり、財務指標が改善する。</td></tr>
            <tr><td><b>IFRS16</b></td><td style="text-align:left">国際会計基準（IASB発行）のリース会計基準。EU・アジア等で適用。借手のリースを原則オンバランス化。</td></tr>
            <tr><td><b>ASC842</b></td><td style="text-align:left">米国会計基準（FASB発行）のリース会計基準。内容はIFRS16とほぼ同様。</td></tr>
            <tr><td><b>新リース会計基準</b></td><td style="text-align:left">日本の企業会計基準委員会（ASBJ）が策定。2027年4月〜強制適用。IFRS16に準拠。</td></tr>
            <tr><td><b>少額リース免除</b></td><td style="text-align:left">IFRS16の免除規定。新品時の価値がUSD 5,000（約75万円）以下の資産リースはオフバランス可。PC・タブレット等が該当。施設什器は通常該当しない。</td></tr>
            <tr><td><b>使用権資産</b></td><td style="text-align:left">リース契約により借手が得る「使用する権利」を資産計上したもの。新基準で導入。</td></tr>
            <tr><td><b>リース負債</b></td><td style="text-align:left">将来のリース料支払義務を負債計上したもの。使用権資産と対で計上される。</td></tr>
            <tr><td><b>減価償却</b></td><td style="text-align:left">固定資産の取得原価を耐用年数にわたり費用配分する会計処理。定額法が一般的。</td></tr>
            <tr><td><b>耐用年数</b></td><td style="text-align:left">税法で定められた資産の使用可能期間。建物RC: 39年、附属設備: 15年、木造: 22年 等。</td></tr>
            <tr><td><b>LTV</b></td><td style="text-align:left">Loan to Value。総投資額に対する借入比率。LTV75% = 75%を銀行融資で調達。</td></tr>
            <tr><td><b>NOI</b></td><td style="text-align:left">Net Operating Income。建物オーナーの年間営業純利益。運営会社から受け取る建物賃料から、管理費・税金等を引いた金額。</td></tr>
            <tr><td><b>DSCR</b></td><td style="text-align:left">Debt Service Coverage Ratio。NOI ÷ 年間返済額。1.2倍以上が融資審査の目安。2.0倍超は優良。</td></tr>
            <tr><td><b>EBITDA</b></td><td style="text-align:left">利払・税・償却前利益。キャッシュフローの実力を示す指標。新基準ではリース料がEBITDAから除外され、見かけ上改善する。</td></tr>
            <tr><td><b>SPC / SPV</b></td><td style="text-align:left">Special Purpose Company / Vehicle。特定目的会社。資産保有や倒産隔離のために設立する法人（合同会社等）。</td></tr>
            <tr><td><b>REIT</b></td><td style="text-align:left">Real Estate Investment Trust。不動産投資信託。複数の不動産をファンド化して投資家に販売する仕組み。</td></tr>
            <tr><td><b>倒産隔離</b></td><td style="text-align:left">運営会社が倒産しても資産が保全される法的構造。SPC分離により実現。</td></tr>
            </table></div>`;
        }

        function disclaimerHTML(){
            return `<div style="margin-top:2rem;padding:1.5rem 2rem;border:2px solid var(--charcoal);background:var(--cream);page-break-inside:avoid">
            <div style="font-size:.82rem;font-weight:700;color:var(--charcoal);letter-spacing:.04em;margin-bottom:.8rem">ご利用者さまへ</div>
            <div style="font-size:.78rem;color:var(--charcoal);line-height:2">
            本案件は資産計上方法により <b>BS・借入余力・税務</b> が変わります。<br>
            当社としては <b>オンバランス型</b>　<b>オフバランス型</b>　<b>SPV型</b><br>
            いずれの設計も可能です。<br><br>
            最終判断は <b>御社顧問税理士・金融機関</b> とご相談の上決定ください。
            </div>
            <div style="margin-top:1rem;text-align:right;font-size:.7rem;color:var(--gray-400)">TAmJ株式会社</div>
            </div>`;
        }

        function previewHeaderHTML(){
            const d=new Date();
            const ds=`${d.getFullYear()}年${d.getMonth()+1}月${d.getDate()}日`;
            let h=`<div style="display:flex;justify-content:space-between;padding:1.2rem 0;margin-bottom:1rem;border-bottom:2px solid var(--charcoal)">`;
            h+=`<div><div contenteditable="true" style="font-size:.95rem;font-weight:600;outline:none">〇〇〇〇 株式会社 <span style="font-size:.8rem;font-weight:400">御中</span></div><div contenteditable="true" style="font-size:.7rem;color:var(--gray-400);margin-top:2px;outline:none">ご担当：〇〇 〇〇 様</div></div>`;
            h+=`<div style="text-align:right;font-size:.68rem;line-height:1.7;color:var(--gray-500)"><div style="font-size:.85rem;font-weight:700;color:var(--charcoal)">タムジ株式会社</div><div>〒103-0004</div><div>東京都中央区東日本橋3-3-17 Re-Know4B</div><div>mail：info@tamjump.com</div><div style="color:var(--gray-400);margin-top:2px">${ds}</div></div>`;
            h+=`</div>`;
            return h;
        }

        // ══ BS影響概算表プレビュー ══
        function openBSPreview(){
            const s=getSimData();if(!s){alert('データがありません');return;}
            const{fac,inp,comp,land,buildMid,totalMid,isPurchase}=s;
            const lr=.75,loan=Math.round(totalMid*lr);
            const dm=((comp.devTasksCost?.min||0)+(comp.devTasksCost?.max||0))/2;
            const st=inp.structure||'RC',ul=st.includes('木')?22:39;
            let h=previewHeaderHTML();

            // ━━━━━ ① 支配パート ━━━━━
            h+=`<div style="text-align:center;padding:2.5rem 1.5rem 2rem;border-bottom:1px solid var(--gray-200)">`;
            h+=`<div style="font-size:.65rem;letter-spacing:4px;text-transform:uppercase;color:var(--gray-400);margin-bottom:1rem">Development × Financial Design</div>`;
            h+=`<div style="font-family:var(--font-serif);font-size:1.15rem;font-weight:400;color:var(--charcoal);line-height:2;letter-spacing:.06em">`;
            h+=`本開発は 建物だけではなく<br><b style="border-bottom:2px solid var(--primary)">財務設計まで統合して設計</b> します</div>`;
            h+=`</div>`;

            // ━━━━━ ② 選べる3構造 ━━━━━
            h+=`<div style="padding:2rem 0">`;
            h+=`<div style="text-align:center;font-size:.7rem;letter-spacing:3px;color:var(--gray-400);margin-bottom:1.5rem">SELECT YOUR STRUCTURE</div>`;
            h+=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">`;
            // A
            h+=`<div style="border:2px solid var(--charcoal);padding:1.2rem;text-align:center">`;
            h+=`<div style="font-size:.6rem;letter-spacing:2px;color:var(--gray-400);margin-bottom:.5rem">TYPE A</div>`;
            h+=`<div style="font-weight:700;font-size:.9rem;color:var(--charcoal);margin-bottom:.6rem">オンバランス型</div>`;
            h+=`<div style="font-size:.72rem;color:var(--gray-500);line-height:1.7">資産化して企業価値UP<br>融資評価・担保化に有利</div></div>`;
            // B
            h+=`<div style="border:2px solid var(--gray-300);padding:1.2rem;text-align:center">`;
            h+=`<div style="font-size:.6rem;letter-spacing:2px;color:var(--gray-400);margin-bottom:.5rem">TYPE B</div>`;
            h+=`<div style="font-weight:700;font-size:.9rem;color:var(--charcoal);margin-bottom:.6rem">オフバランス型</div>`;
            h+=`<div style="font-size:.72rem;color:var(--gray-500);line-height:1.7">BS軽量化<br>運営リスク分離</div></div>`;
            // C
            h+=`<div style="border:2px solid var(--primary);padding:1.2rem;text-align:center">`;
            h+=`<div style="font-size:.6rem;letter-spacing:2px;color:var(--primary);margin-bottom:.5rem">TYPE C</div>`;
            h+=`<div style="font-weight:700;font-size:.9rem;color:var(--charcoal);margin-bottom:.6rem">SPC分離型</div>`;
            h+=`<div style="font-size:.72rem;color:var(--gray-500);line-height:1.7">完全資産分離<br>投資スキーム対応</div></div>`;
            h+=`</div></div>`;

            // ━━━━━ ③ なぜ重要か ━━━━━
            h+=`<div style="text-align:center;padding:1.5rem;background:var(--cream);border-top:1px solid var(--gray-200);border-bottom:1px solid var(--gray-200);margin-bottom:2rem">`;
            h+=`<div style="font-family:var(--font-serif);font-size:.92rem;color:var(--charcoal);line-height:2;letter-spacing:.04em">`;
            h+=`同じ建物でも <b>持ち方</b> で<br>利益・借入余力・企業価値は変わる</div></div>`;

            // ━━━━━ ④ 参考資料ゾーン ━━━━━
            h+=`<div style="border-top:3px solid var(--charcoal);padding-top:1.5rem;margin-top:.5rem">`;
            h+=`<div style="font-size:.6rem;letter-spacing:4px;text-transform:uppercase;color:var(--gray-400);margin-bottom:1.5rem;text-align:center">REFERENCE ─ 詳細データ</div>`;

            // メタ情報
            h+=`<div class="pv-meta"><span>作成日: ${new Date().toLocaleDateString('ja-JP')}</span><span>施設: ${facilityNames[fac.facilityType]||fac.facilityType} / ${fac.residents||0}人</span><span>構造: ${st}（耐用年数${ul}年）</span></div>`;

            // 資産
            h+=`<div class="pv-section"><div class="pv-section-title">資産の部（増加）</div><table class="pv-table"><tr><th>勘定科目</th><th>金額（税抜）</th><th>耐用年数</th><th>年間償却額</th></tr>`;
            if(isPurchase) h+=`<tr><td>土地</td><td>${yen(land.land_price||0)}</td><td>—（非償却）</td><td>—</td></tr>`;
            h+=`<tr><td>建物</td><td>${yen(buildMid)}</td><td>${ul}年</td><td>${yen(Math.round(buildMid/ul))}</td></tr>`;
            h+=`<tr><td>建物附属設備</td><td>${yen(Math.round(buildMid*.23))}</td><td>15年</td><td>${yen(Math.round(buildMid*.23/15))}</td></tr>`;
            h+=`<tr><td>構築物</td><td>${yen(Math.round(buildMid*.04))}</td><td>15年</td><td>${yen(Math.round(buildMid*.04/15))}</td></tr>`;
            if(dm>0) h+=`<tr><td>開業費（繰延資産）</td><td>${yen(Math.round(dm))}</td><td>5年（均等）</td><td>${yen(Math.round(dm/5))}</td></tr>`;
            const td=Math.round(buildMid/ul)+Math.round(buildMid*.23/15)+Math.round(buildMid*.04/15)+(dm>0?Math.round(dm/5):0);
            h+=`<tr class="subtotal"><td>償却合計</td><td></td><td></td><td>${yen(td)}/年</td></tr></table></div>`;

            // 負債
            h+=`<div class="pv-section"><div class="pv-section-title">負債の部</div><table class="pv-table"><tr><th>勘定科目</th><th>金額</th><th>条件</th><th>年間利息</th></tr>`;
            h+=`<tr><td>長期借入金</td><td>${yen(loan)}</td><td>LTV${Math.round(lr*100)}% / 金利2.0%</td><td>${yen(Math.round(loan*.02))}</td></tr></table></div>`;

            // 純資産
            h+=`<div class="pv-section"><div class="pv-section-title">純資産の部</div><table class="pv-table"><tr><th>勘定科目</th><th>金額</th><th>備考</th></tr>`;
            h+=`<tr><td>自己資金</td><td>${yen(Math.round(totalMid*(1-lr)))}</td><td>総投資額の${Math.round((1-lr)*100)}%</td></tr></table></div>`;

            // PL影響
            h+=`<div class="pv-section"><div class="pv-section-title">年間PL影響</div><table class="pv-table"><tr><th>費用科目</th><th>金額/年</th><th>算出根拠</th></tr>`;
            h+=`<tr><td>減価償却費（建物）</td><td>${yen(Math.round(buildMid/ul))}</td><td>定額法 ${ul}年</td></tr>`;
            h+=`<tr><td>減価償却費（附属設備）</td><td>${yen(Math.round(buildMid*.23/15))}</td><td>定額法 15年</td></tr>`;
            h+=`<tr><td>支払利息</td><td>${yen(Math.round(loan*.02))}</td><td>金利2.0%</td></tr>`;
            if(!isPurchase) h+=`<tr><td>地代家賃</td><td>${yen(Math.round((land.ground_rent_month||0)*12))}</td><td>月額×12</td></tr>`;
            h+=`<tr><td>固定資産税</td><td>${yen(Math.round(buildMid*.004+(isPurchase?(land.land_price||0)*.01:0)))}</td><td>概算</td></tr></table></div>`;

            // オンバラ判定
            h+=`<div class="pv-section"><div class="pv-section-title">オンバランス / オフバランス 判定</div><table class="pv-table"><tr><th>項目</th><th>判定</th><th>根拠</th></tr>`;
            h+=`<tr><td>土地</td><td>${isPurchase?'<span class="pv-badge on">ON</span>':'<span class="pv-badge off">OFF</span>'}</td><td>${isPurchase?'購入→BS計上':'借地→地代費用処理'}</td></tr>`;
            h+=`<tr><td>建物</td><td><span class="pv-badge on">ON</span></td><td>自社所有→BS計上</td></tr>`;
            h+=`<tr><td>什器備品（購入）</td><td><span class="pv-badge on">ON</span></td><td>固定資産→減価償却</td></tr>`;
            h+=`<tr><td>什器備品（リース）</td><td><span class="pv-badge on">原則ON</span></td><td>IFRS16/ASC842/新リース基準 → 原則オンバランス（例外: 12ヶ月以内 or 少額資産のみOFF）</td></tr></table></div>`;

            // スキーム別
            h+=`<div class="pv-section"><div class="pv-section-title">スキーム別 BS影響シミュレーション</div>`;
            h+=`<table class="pv-table"><tr><th>スキーム</th><th>資産計上</th><th>BS影響</th><th>主な用途</th></tr>`;
            h+=`<tr><td><b>① 自社保有型</b></td><td><span class="pv-badge on">ON</span></td><td>全資産オンバランス → 担保化可能</td><td>銀行評価UP・融資最大化</td></tr>`;
            h+=`<tr><td><b>② 投資家売却型</b></td><td><span class="pv-badge on">ON</span>→売却</td><td>SPV持分売却 → 譲渡税軽減</td><td>出口戦略・M&A扱い</td></tr>`;
            h+=`<tr><td><b>③ SPV分離型</b></td><td><span class="pv-badge off">OFF</span></td><td>運営のみ → 超軽量BS</td><td>全国展開・多拠点</td></tr>`;
            h+=`<tr><td><b>④ REIT化ルート</b></td><td><span class="pv-badge off">OFF</span></td><td>SPV束ね → 私募REIT</td><td>大規模出口・数百億</td></tr>`;
            h+=`<tr><td><b>⑤ 海外投資家型</b></td><td><span class="pv-badge off">OFF</span></td><td>SPV出資受入 → 直接所有回避</td><td>SG/HK/UAE/US投資家</td></tr>`;
            h+=`</table>`;
            h+=`<div class="pv-note"><b>推奨：三層構造（資産保有SPC ＋ 運営会社 ＋ 投資ファンド）</b><br>`;
            h+=`全パターンに対応可能な可変型構造。スキーム変更時もBS組替不要。<br>`;
            h+=`→ 詳細はお問合せください</div></div>`;

            h+=`</div>`; // close reference zone

            // ━━━━━ ⑤ 用語解説 + 免責 ━━━━━
            h+=glossaryHTML();
            h+=disclaimerHTML();

            document.getElementById('bsPreviewBody').innerHTML=h;
            document.getElementById('bsPreview').classList.add('show');document.body.classList.add('preview-open');
            document.body.style.overflow='hidden';
        }

        // ══ リース仕訳シートプレビュー ══
        function openLeasePreview(){
            const s=getSimData();if(!s){alert('データがありません');return;}
            const{fac,buildMid}=s;
            const la=Math.round(buildMid*.30),lt=60,ar=.035,mr=ar/12;
            const mp=Math.round(la*mr/(1-Math.pow(1+mr,-lt)));
            const ad=Math.round(la/(lt/12));
            let h=previewHeaderHTML();

            // ━━━━━ ① 支配パート ━━━━━
            h+=`<div style="text-align:center;padding:2.5rem 1.5rem 2rem;border-bottom:1px solid var(--gray-200)">`;
            h+=`<div style="font-size:.65rem;letter-spacing:4px;text-transform:uppercase;color:var(--gray-400);margin-bottom:1rem">Lease Accounting Design</div>`;
            h+=`<div style="font-family:var(--font-serif);font-size:1.15rem;font-weight:400;color:var(--charcoal);line-height:2;letter-spacing:.06em">`;
            h+=`リース資産の <b style="border-bottom:2px solid var(--primary)">会計処理も設計</b> します</div>`;
            h+=`</div>`;

            // ━━━━━ ② 選べるリース構造 ━━━━━
            h+=`<div style="padding:2rem 0">`;
            h+=`<div style="text-align:center;font-size:.7rem;letter-spacing:3px;color:var(--gray-400);margin-bottom:1.5rem">SELECT YOUR STRUCTURE</div>`;
            h+=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">`;
            h+=`<div style="border:2px solid var(--charcoal);padding:1.2rem;text-align:center">`;
            h+=`<div style="font-size:.6rem;letter-spacing:2px;color:var(--gray-400);margin-bottom:.5rem">TYPE A</div>`;
            h+=`<div style="font-weight:700;font-size:.9rem;color:var(--charcoal);margin-bottom:.6rem">自社リース契約</div>`;
            h+=`<div style="font-size:.72rem;color:var(--gray-500);line-height:1.7">オンバランス計上<br>使用権資産＋リース負債</div></div>`;
            h+=`<div style="border:2px solid var(--gray-300);padding:1.2rem;text-align:center">`;
            h+=`<div style="font-size:.6rem;letter-spacing:2px;color:var(--gray-400);margin-bottom:.5rem">TYPE B</div>`;
            h+=`<div style="font-weight:700;font-size:.9rem;color:var(--charcoal);margin-bottom:.6rem">メーカーレンタル</div>`;
            h+=`<div style="font-size:.72rem;color:var(--gray-500);line-height:1.7">所有権移転なし<br>オフバランス処理</div></div>`;
            h+=`<div style="border:2px solid var(--primary);padding:1.2rem;text-align:center">`;
            h+=`<div style="font-size:.6rem;letter-spacing:2px;color:var(--primary);margin-bottom:.5rem">TYPE C</div>`;
            h+=`<div style="font-weight:700;font-size:.9rem;color:var(--charcoal);margin-bottom:.6rem">SPC経由リース</div>`;
            h+=`<div style="font-size:.72rem;color:var(--gray-500);line-height:1.7">資産隔離＋運営軽量化<br>完全オフバランス</div></div>`;
            h+=`</div></div>`;

            // ━━━━━ ③ なぜ重要か ━━━━━
            h+=`<div style="text-align:center;padding:1.5rem;background:var(--cream);border-top:1px solid var(--gray-200);border-bottom:1px solid var(--gray-200);margin-bottom:2rem">`;
            h+=`<div style="font-family:var(--font-serif);font-size:.92rem;color:var(--charcoal);line-height:2;letter-spacing:.04em">`;
            h+=`同じ什器でも <b>持ち方</b> で<br>EBITDA・有利子負債・財務指標は変わる</div></div>`;

            // ━━━━━ ④ 参考資料ゾーン ━━━━━
            h+=`<div style="border-top:3px solid var(--charcoal);padding-top:1.5rem;margin-top:.5rem">`;
            h+=`<div style="font-size:.6rem;letter-spacing:4px;text-transform:uppercase;color:var(--gray-400);margin-bottom:1.5rem;text-align:center">REFERENCE ─ 詳細データ</div>`;

            h+=`<div class="pv-meta"><span>適用基準: IFRS16 / ASC842 / 日本基準（2027年〜）</span><span>作成日: ${new Date().toLocaleDateString('ja-JP')}</span></div>`;

            // 前提条件
            h+=`<div class="pv-section"><div class="pv-section-title">リース前提条件</div><table class="pv-table"><tr><th>項目</th><th>値</th></tr>`;
            h+=`<tr><td>リース対象</td><td style="text-align:left">什器備品（建築費の約30%）</td></tr>`;
            h+=`<tr><td>リース元本</td><td>${yen(la)}</td></tr><tr><td>リース期間</td><td>${lt}ヶ月（${lt/12}年）</td></tr>`;
            h+=`<tr><td>年利</td><td>${(ar*100).toFixed(1)}%</td></tr><tr><td>月額リース料</td><td>${yen(mp)}</td></tr>`;
            h+=`<tr class="subtotal"><td>リース料総額</td><td>${yen(mp*lt)}</td></tr></table></div>`;

            // 開始仕訳
            h+=`<div class="pv-section"><div class="pv-section-title">開始日の仕訳</div><table class="pv-table"><tr><th>借方</th><th>金額</th><th>貸方</th><th>金額</th></tr>`;
            h+=`<tr><td>使用権資産</td><td>${yen(la)}</td><td>リース負債</td><td>${yen(la)}</td></tr></table></div>`;

            // 月次
            h+=`<div class="pv-section"><div class="pv-section-title">月次仕訳スケジュール（1年目）</div><table class="pv-table"><tr><th>月</th><th>支払利息</th><th>元本返済</th><th>月額支払</th><th>負債残高</th></tr>`;
            let bal=la;
            for(let m=1;m<=12;m++){const i=Math.round(bal*mr),p=mp-i;bal-=p;h+=`<tr><td>${m}ヶ月目</td><td>${yen(i)}</td><td>${yen(p)}</td><td>${yen(mp)}</td><td>${yen(bal)}</td></tr>`}
            h+=`<tr class="subtotal"><td>1年目計</td><td>${yen(Math.round(la*ar))}</td><td>${yen(mp*12-Math.round(la*ar))}</td><td>${yen(mp*12)}</td><td>${yen(bal)}</td></tr></table>`;
            h+=`<div class="pv-note">※ 2年目以降も${lt}ヶ月目まで同様に計算されます。</div></div>`;

            // 年次償却
            h+=`<div class="pv-section"><div class="pv-section-title">年次減価償却</div><table class="pv-table"><tr><th>年度</th><th>減価償却費</th><th>使用権資産（減）</th><th>残存簿価</th></tr>`;
            let bv=la;for(let y=1;y<=lt/12;y++){bv-=ad;h+=`<tr><td>${y}年目</td><td>${yen(ad)}</td><td>${yen(ad)}</td><td>${yen(Math.max(0,bv))}</td></tr>`}
            h+=`</table></div>`;

            // BSサマリー
            h+=`<div class="pv-section"><div class="pv-section-title">BS影響サマリー</div><table class="pv-table"><tr><th>勘定科目</th><th>増減</th><th>金額</th></tr>`;
            h+=`<tr><td>使用権資産</td><td>増加</td><td>${yen(la)}</td></tr>`;
            h+=`<tr><td>リース負債（流動）</td><td>増加</td><td>${yen(Math.round(la/lt*12))}</td></tr>`;
            h+=`<tr><td>リース負債（固定）</td><td>増加</td><td>${yen(Math.round(la-la/lt*12))}</td></tr></table></div>`;

            // 新旧比較
            h+=`<div class="pv-section"><div class="pv-section-title">新基準 vs 旧基準 比較</div><div class="pv-compare">`;
            h+=`<div class="pv-compare-head">新基準（IFRS16）</div><div class="pv-compare-head">旧基準（オペリース）</div>`;
            h+=`<div class="pv-compare-cell"><b>BS:</b> 使用権資産＋リース負債をオンバランス</div><div class="pv-compare-cell"><b>BS:</b> オフバランス（注記のみ）</div>`;
            h+=`<div class="pv-compare-cell"><b>PL:</b> 減価償却費＋支払利息</div><div class="pv-compare-cell"><b>PL:</b> リース料（定額）</div>`;
            h+=`<div class="pv-compare-cell"><b>1年目:</b> ${yen(ad+Math.round(la*ar))}</div><div class="pv-compare-cell"><b>1年目:</b> ${yen(mp*12)}</div>`;
            h+=`<div class="pv-compare-cell"><b>EBITDA:</b> リース料除外（改善）</div><div class="pv-compare-cell"><b>EBITDA:</b> リース料含む</div>`;
            h+=`<div class="pv-compare-cell"><b>有利子負債:</b> 増加</div><div class="pv-compare-cell"><b>有利子負債:</b> 影響なし</div>`;
            h+=`</div></div>`;

            // オフバラ戦略
            h+=`<div class="pv-section"><div class="pv-section-title">リース資産 オフバランス戦略</div>`;
            h+=`<table class="pv-table"><tr><th>方法</th><th>スキーム</th><th>BS影響</th><th>備考</th></tr>`;
            h+=`<tr class="highlight"><td><b>原則（現行基準）</b></td><td>借手がリース契約</td><td><span class="pv-badge on">ON</span></td><td>IFRS16/ASC842/新基準 → 使用権資産＋負債計上</td></tr>`;
            h+=`<tr><td><b>例外① 短期</b></td><td>12ヶ月以内のリース</td><td><span class="pv-badge off">OFF</span></td><td>費用処理のみ</td></tr>`;
            h+=`<tr><td><b>例外② 少額</b></td><td>少額資産リース</td><td><span class="pv-badge off">OFF</span></td><td>IFRS16: USD5,000（約75万円）以下</td></tr>`;
            h+=`<tr><td><b>戦略① SPC所有</b></td><td>SPC保有 → 運営会社へ賃貸</td><td><span class="pv-badge off">OFF</span></td><td>運営会社BSから完全分離</td></tr>`;
            h+=`<tr><td><b>戦略② メーカー所有</b></td><td>メーカー所有 → レンタル</td><td><span class="pv-badge off">OFF</span></td><td>所有権移転なし</td></tr>`;
            h+=`<tr><td><b>戦略③ リースSPC</b></td><td>什器専用SPC設立</td><td><span class="pv-badge off">OFF</span></td><td>資産隔離＋運営軽量化</td></tr>`;
            h+=`</table>`;
            h+=`<div class="pv-note"><b>施設什器リース（5年）= ほぼ100%オンバランス</b><br>`;
            h+=`オフバランス化にはSPC分離 or レンタル構造が必要。<br>`;
            h+=`→ 詳細はお問合せください</div></div>`;

            h+=`</div>`; // close reference zone

            // ━━━━━ ⑤ 用語解説 + 免責 ━━━━━
            h+=glossaryHTML();
            h+=disclaimerHTML();

            document.getElementById('leasePreviewBody').innerHTML=h;
            document.getElementById('leasePreview').classList.add('show');document.body.classList.add('preview-open');
            document.body.style.overflow='hidden';
        }

        function closePreview(id){document.getElementById(id).classList.remove('show');document.body.classList.remove('preview-open');document.body.style.overflow=''}

        // 共通: 会社ヘッダーHTML
        function companyHeaderHTML(title, dateStr){
            return `<div class="no-print" style="text-align:center;margin-bottom:16px"><button onclick="window.print()" style="padding:10px 32px;font-size:13px;font-weight:600;background:#333;color:#fff;border:none;cursor:pointer">印刷 / PDF保存</button><button onclick="window.close()" style="padding:10px 24px;font-size:13px;background:#fff;border:1px solid #999;cursor:pointer;margin-left:8px">閉じる</button></div>
<div style="text-align:center;margin-bottom:18px;border-bottom:3px double #333;padding-bottom:14px"><h1 style="font-size:22px;font-weight:700;letter-spacing:.3em">${title}</h1><div style="font-size:9px;color:#666">${dateStr}</div></div>
<div style="display:flex;justify-content:space-between;margin-bottom:16px">
<div style="flex:1"><div contenteditable="true" style="font-size:14px;font-weight:500;border-bottom:1px solid #333;padding-bottom:4px;outline:none">〇〇〇〇 株式会社 <span style="font-size:11px;font-weight:400">御中</span></div><div contenteditable="true" style="font-size:9px;color:#888;margin-top:2px;outline:none">ご担当：〇〇 〇〇 様</div></div>
<div style="text-align:right;font-size:9px;line-height:1.7"><div style="font-size:12px;font-weight:700">タムジ株式会社</div><div>〒103-0004</div><div>東京都中央区東日本橋3-3-17 Re-Know4B</div><div>mail：info@tamjump.com</div></div>
</div>`;
        }
        function docStyles(){
            return `@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Inter:wght@400;600&display=swap');*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Noto Sans JP',sans-serif;font-size:10px;color:#1a1a1a;line-height:1.6;padding:20mm 15mm;max-width:210mm;margin:0 auto}table{width:100%;border-collapse:collapse;font-size:9px;margin-bottom:12px}th{background:#333;color:#fff;font-weight:500;padding:5px 8px;text-align:left}td{padding:4px 8px;border-bottom:1px solid #e0e0e0}.r{text-align:right}.subtotal td{background:#f5f5f3;font-weight:600}.section{margin-bottom:16px}.section-title{font-weight:700;font-size:11px;border-bottom:2px solid #333;padding-bottom:4px;margin-bottom:8px}.note{font-size:8.5px;color:#555;line-height:1.8;border-top:1px solid #ccc;padding-top:10px;margin-top:14px}.badge-on{display:inline-block;background:#333;color:#fff;font-size:8px;padding:1px 6px;font-weight:600}.badge-off{display:inline-block;background:#fff;color:#333;border:1px solid #333;font-size:8px;padding:1px 6px;font-weight:600}@media print{.no-print{display:none!important}@page{size:A4;margin:10mm}}`;
        }
        function printPreview(id){
            const previewBody=document.getElementById(id.replace('Preview','PreviewBody')||id+'Body');
            if(!previewBody) { window.print(); return; }
            const today=new Date();
            const dateStr=`${today.getFullYear()}年${today.getMonth()+1}月${today.getDate()}日`;
            const titleMap={'bsPreview':'BS影響概算表','leasePreview':'リース会計設計'};
            const title=titleMap[id]||'資料';
            const w=window.open('','_blank','width=900,height=1200');
            w.document.write(`<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><title>${title}</title><style>${docStyles()}</style></head><body>`);
            w.document.write(companyHeaderHTML(title, dateStr));
            w.document.write(`<div style="font-size:9px">${previewBody.innerHTML}</div>`);
            w.document.write(`<div class="note"><b>備考</b><br>・本資料はシミュレーションに基づく概算であり、正式な会計処理は顧問税理士にご確認ください。<br>・表示価格はすべて税抜です。</div>`);
            w.document.write('</body></html>');
            w.document.close();
        }

        // 印刷/PDF（メイン見積画面）
        function printEstimateDev(){
            const s=getSimData();if(!s){alert('データがありません');return;}
            const{fac,inp,comp,land,buildMin,buildMax,buildMid,totalMid,isPurchase,residents,gfa}=s;
            const today=new Date();
            const dateStr=`${today.getFullYear()}年${today.getMonth()+1}月${today.getDate()}日`;
            const estNo=`DV-${today.getFullYear()}${String(today.getMonth()+1).padStart(2,'0')}${String(today.getDate()).padStart(2,'0')}-${String(Math.floor(Math.random()*900)+100)}`;
            const taxPct=inp.taxRate||10;
            const fmt=n=>n>0?'¥'+Math.round(n).toLocaleString('ja-JP'):'—';
            const fmtR=(a,b)=>{a=Math.round(a);b=Math.round(b);return a===b?fmt(a):`${fmt(a)}〜${fmt(b)}`};

            const landNet=isPurchase?(land.land_price||0):0;
            const landFeesNet=(land.landFees_auto_net||0)+(land.landFees_manual_net||0);
            const designNet=Math.round(buildMid*0.06);
            const registryNet=Math.round(buildMid*0.008);
            const contingencyNet=Math.round(buildMid*0.04);
            const leasingNet=Math.round(residents*50000);
            const otherNet=designNet+registryNet+contingencyNet+leasingNet;
            const devMin=comp.devTasksCost?.min||0, devMax=comp.devTasksCost?.max||0;
            const tMin=comp.summary?.totalMin||0, tMax=comp.summary?.totalMax||0;
            const tx=n=>Math.round(n*(1+taxPct/100));

            let rows='';
            rows+=`<tr><td>土地${isPurchase?'（購入）':'（借地）'}</td><td class="r">${fmt(landNet)}</td><td class="r">${fmt(tx(landNet))}</td></tr>`;
            rows+=`<tr><td>土地関連費</td><td class="r">${fmt(Math.round(landFeesNet))}</td><td class="r">${fmt(tx(landFeesNet))}</td></tr>`;
            rows+=`<tr><td>建築費</td><td class="r">${fmtR(buildMin,buildMax)}</td><td class="r">${fmtR(tx(buildMin),tx(buildMax))}</td></tr>`;
            rows+=`<tr><td>　設計・管理費</td><td class="r" style="color:#666">${fmt(designNet)}</td><td></td></tr>`;
            rows+=`<tr><td>　登記・士業等</td><td class="r" style="color:#666">${fmt(registryNet)}</td><td></td></tr>`;
            rows+=`<tr><td>　予備費</td><td class="r" style="color:#666">${fmt(contingencyNet)}</td><td></td></tr>`;
            rows+=`<tr><td>　リーシング</td><td class="r" style="color:#666">${fmt(leasingNet)}</td><td></td></tr>`;
            rows+=`<tr><td>建築その他 小計</td><td class="r">${fmt(otherNet)}</td><td class="r">${fmt(tx(otherNet))}</td></tr>`;
            rows+=`<tr><td>開発作業</td><td class="r">${fmtR(devMin,devMax)}</td><td class="r">${fmtR(tx(devMin),tx(devMax))}</td></tr>`;
            rows+=`<tr style="border-top:2px solid #333;border-bottom:2px solid #333;font-weight:700;font-size:11px"><td>トータルインベストメント</td><td class="r">${fmtR(tMin/(1+taxPct/100),tMax/(1+taxPct/100))}</td><td class="r">${fmtR(tMin,tMax)}</td></tr>`;

            const noiY=comp.summary?.noiY||0;
            const noiYield=comp.summary?.noiYield||0;
            const grossYield=comp.summary?.grossYield||0;

            const w=window.open('','_blank','width=900,height=1200');
            w.document.write(`<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><title>開発概算見積書</title><style>${docStyles()}</style></head><body>`);
            w.document.write(companyHeaderHTML('開発概算見積書', `${dateStr}　No. ${estNo}`));
            w.document.write(`<div style="background:#f5f5f3;border:2px solid #333;padding:12px 20px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center"><div><div style="font-size:11px;font-weight:500">お見積り金額（税込）</div><div style="font-size:20px;font-weight:700;font-family:'Inter',sans-serif">${fmtR(tMin,tMax)}</div></div><div style="font-size:9px;color:#555;text-align:right;line-height:1.8">施設：${facilityNames[fac.facilityType]||fac.facilityType} / ${residents}人<br>構造：${inp.structure||'RC'} / ${inp.floors||2}階<br>延床：${Math.round(inp.gfa_m2||0).toLocaleString()}㎡</div></div>`);
            const mi=comp.marketIndex;
            w.document.write(`<div style="display:flex;gap:24px;margin-bottom:14px;font-size:9px;color:#444"><div>有効期限：発行日より30日間</div><div>グレード：A工事単価ベース</div>${mi?.enabled?`<div style="color:#C8161D;font-weight:600">MCI ${(1+((mi.mci||1)-1)*(mi.smoothing||0.6)).toFixed(4)} 適用</div>`:''}</div>`);
            w.document.write(`<table><thead><tr><th>区分</th><th class="r" style="width:120px">税抜</th><th class="r" style="width:120px">税込</th></tr></thead><tbody>${rows}</tbody></table>`);
            // ── A+B工事内訳 ──
            w.document.write(`<div style="margin-top:20px;page-break-before:auto"><div style="font-weight:700;font-size:11px;border-bottom:2px solid #333;padding-bottom:4px;margin-bottom:8px">建築費（A+B工事）内訳</div>`);
            w.document.write(`<table><thead><tr><th>工事項目</th><th>内容</th><th class="r" style="width:100px">金額（税抜）</th></tr></thead><tbody>`);
            let tA=0;
            A_BREAKDOWN_RATIOS.forEach(c=>{
                const ct=buildMid*c.ratio; tA+=ct;
                w.document.write(`<tr style="background:#f5f5f3"><td colspan="2" style="font-weight:600">${c.category}</td><td class="r" style="font-weight:600">${fmt(Math.round(ct))}</td></tr>`);
                c.items.forEach(i=>w.document.write(`<tr><td style="padding-left:16px;color:#555">${i.name}</td><td style="color:#888;font-size:8px">${i.note}</td><td class="r">${fmt(Math.round(ct*i.ratio))}</td></tr>`));
            });
            w.document.write(`<tr style="border-top:2px solid #333"><td colspan="2" style="font-weight:700">A工事 小計</td><td class="r" style="font-weight:700">${fmt(Math.round(tA))}</td></tr>`);
            w.document.write(`<tr style="background:#f5f5f3"><td colspan="3" style="font-weight:600;color:#C8161D">B工事（付帯工事）</td></tr>`);
            let tB=0;
            B_BREAKDOWN.forEach(i=>{
                let c=i.unitPrice||0; if(i.perRoom)c=i.perRoom*residents; tB+=c;
                w.document.write(`<tr><td style="padding-left:16px;color:#555">${i.name}</td><td style="color:#888;font-size:8px">${i.note}</td><td class="r">${fmt(c)}</td></tr>`);
            });
            w.document.write(`<tr style="border-top:1px solid #999"><td colspan="2" style="font-weight:700">B工事 小計</td><td class="r" style="font-weight:700">${fmt(tB)}</td></tr>`);
            w.document.write(`<tr style="border-top:2px solid #333;border-bottom:2px solid #333"><td colspan="2" style="font-weight:700;font-size:11px">A+B工事 合計（税抜）</td><td class="r" style="font-weight:700;font-size:11px">${fmt(Math.round(tA+tB))}</td></tr>`);
            w.document.write(`</tbody></table>`);
            w.document.write(`<p style="font-size:6.5px;color:#888;margin:-6px 0 8px;line-height:1.5">※坪単価は全国平均・介護施設（2F）・用途係数1.0・指数調整なしの基準値です。個別案件では地域・階数・用途係数・指数調整により変動します。当社シミュレーターで条件別の概算が可能です。</p>`);
            w.document.write(`<div style="display:flex;gap:16px;font-size:9px;color:#666;margin-top:6px"><span>㎡単価: <b style="color:#333">${fmt(Math.round(buildMid/gfa))}/㎡</b></span><span>坪単価: <b style="color:#333">${fmt(Math.round(buildMid/gfa*3.3))}/坪</b></span><span>延床: <b style="color:#333">${Math.round(gfa).toLocaleString()}㎡</b></span></div></div>`);
            w.document.write(`<div style="margin:16px 0;padding:12px;border:1px solid #ddd;display:flex;justify-content:space-around;font-size:10px"><div>NOI利回り: <b>${noiYield.toFixed(2)}%</b></div><div>表面利回り: <b>${grossYield.toFixed(2)}%</b></div><div>年間NOI: <b>${fmt(noiY)}</b></div></div>`);
            w.document.write(`<div class="note"><b>備考</b><br>・本見積書は概算シミュレーションに基づくものであり、正式な見積りではありません。<br>・A工事単価ベース（動産除外）。B工事は付帯工事の参考値です。<br>・C工事（什器備品）は別途お見積りとなります。<br>・正式な見積りは現地調査・ヒアリング後に作成いたします。<br>・表示価格はすべて税抜です（消費税率${taxPct}%を別途申し受けます）。</div>`);
            w.document.write('</body></html>');
            w.document.close();
        }

        // 建物設備明細（estimate-development.htmlから）
        function openEquipDetail(){
            const s=getSimData();if(!s){alert('データがありません');return;}
            // redirect to service-development with hash to trigger equip breakdown
            const url='service-development.html#equipBreakdown';
            window.open(url,'_blank');
        }

        // ── CSV Downloads ──
        function downloadBSCSV(){
            const s=getSimData();if(!s)return;
            const{fac,inp,comp,land,buildMid,totalMid,isPurchase}=s;
            const lr=.75,loan=Math.round(totalMid*lr),dm=((comp.devTasksCost?.min||0)+(comp.devTasksCost?.max||0))/2;
            const st=inp.structure||'RC',ul=st.includes('木')?22:39;
            let c='\uFEFF';c+='BS影響概算表\n';c+=`作成日,${new Date().toLocaleDateString('ja-JP')}\n施設,${fac.facilityType||''} / ${fac.residents||0}人\n\n`;
            c+='【資産の部】\n勘定科目,金額,耐用年数,年間償却\n';
            if(isPurchase)c+=`土地,${land.land_price||0},—,—\n`;
            c+=`建物,${Math.round(buildMid)},${ul}年,${Math.round(buildMid/ul)}\n`;
            c+=`附属設備,${Math.round(buildMid*.23)},15年,${Math.round(buildMid*.23/15)}\n`;
            c+=`構築物,${Math.round(buildMid*.04)},15年,${Math.round(buildMid*.04/15)}\n`;
            if(dm>0)c+=`開業費,${Math.round(dm)},5年,${Math.round(dm/5)}\n`;
            c+=`\n【負債】\n長期借入金,${loan},LTV${Math.round(lr*100)}%,利息${Math.round(loan*.02)}/年\n`;
            c+=`\n【純資産】\n自己資金,${Math.round(totalMid*(1-lr))}\n`;
            c+=`\n【オンバラ/オフバラ】\n項目,判定,備考\n土地,${isPurchase?'ON':'OFF'},${isPurchase?'購入→BS計上':'借地→地代費用'}\n建物,ON,自社所有\n什器（購入）,ON,固定資産\n什器（リース）,原則ON,IFRS16/新基準（例外:12ヶ月以内or少額のみOFF）\n`;
            dlCSV(c,'BS_impact');
        }
        function downloadLeaseCSV(){
            const s=getSimData();if(!s)return;
            const{fac,buildMid}=s;const la=Math.round(buildMid*.30),lt=60,ar=.035,mr=ar/12;
            const mp=Math.round(la*mr/(1-Math.pow(1+mr,-lt))),ad=Math.round(la/(lt/12));
            let c='\uFEFF';c+='リース仕訳シート\n';c+=`基準,IFRS16/ASC842\n作成日,${new Date().toLocaleDateString('ja-JP')}\n\n`;
            c+='【前提】\n';c+=`元本,${la}\n期間,${lt}ヶ月\n年利,${(ar*100).toFixed(1)}%\n月額,${mp}\n\n`;
            c+='【月次スケジュール】\n月,利息,元本,支払,残高\n';
            let b=la;for(let m=1;m<=lt;m++){const i=Math.round(b*mr),p=mp-i;b-=p;c+=`${m},${i},${p},${mp},${Math.max(0,b)}\n`}
            c+=`\n【年次償却】\n年,償却費,簿価\n`;let bv=la;for(let y=1;y<=lt/12;y++){bv-=ad;c+=`${y},${ad},${Math.max(0,bv)}\n`}
            dlCSV(c,'lease_journal');
        }
        function dlCSV(c,p){const b=new Blob([c],{type:'text/csv;charset=utf-8;'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=p+'_'+new Date().toISOString().slice(0,10)+'.csv';a.click()}

        // ══ マクロ建築指数レポート ══
        function openMCIReport(){
            const s=getSimData();
            const comp=s?.comp||{};
            const mi=comp.marketIndex||{};
            const today=new Date().toISOString().slice(0,10);
            const corpName='タムジ株式会社';
            const corpAddr='〒103-0004 東京都中央区東日本橋3-3-17 Re-Know4B';
            const corpMail='info@tamjump.com';
            const corpTag='TAMJ Macro Construction Index';

            // ── 過去10年データ ──
            const YEARS=[2016,2017,2018,2019,2020,2021,2022,2023,2024,2025,2026];
            const D={
                usdjpy:[108.8,112.2,110.4,109.0,106.8,109.8,131.5,140.5,151.0,148.0,153.4],
                copper:[2.21,2.80,2.96,2.72,2.80,4.23,3.99,3.85,4.15,4.50,5.90],
                brent: [43.7,54.2,71.3,64.2,41.8,70.7,99.0,82.6,80.0,74.0,68.8],
                nikkei:[16920,20210,22310,21700,23850,28830,27500,31500,38500,38000,39188],
                jgb10y:[-0.05,0.05,0.05,-0.10,0.02,0.05,0.20,0.50,0.90,1.30,2.18]
            };
            const COST={
                rc:   [95,100,105,110,108,120,135,155,170,180,185],
                s:    [72,75,80,82,80,88,100,115,130,138,145],
                wood: [55,58,60,62,60,70,80,90,98,105,110],
                mep:  [22,22,23,23,24,25,26,27,28,28,28],
                elec: [4.5,4.8,5.0,5.2,5.5,6.0,7.0,8.0,9.0,9.5,10.0],
                hvac: [3.8,4.0,4.2,4.5,4.8,5.5,6.5,7.5,8.5,9.0,9.5]
            };
            // MCI算出（2019基準＝1.000）
            const BASE_YR=3; // index of 2019
            const W={usdjpy:0.35,copper:0.25,brent:0.15,nikkei:0.15,jgb10y:0.10};
            function calcMCI(yi){
                let sum=0;
                for(const k of Object.keys(W)){
                    if(k==='jgb10y'){
                        sum+=W[k]*((D[k][yi]-D[k][BASE_YR])*0.05);
                    }else{
                        sum+=W[k]*(D[k][yi]/D[k][BASE_YR]-1);
                    }
                }
                return 1+sum;
            }
            const MCI=YEARS.map((_,i)=>calcMCI(i));

            // 7支配要因
            const FACTORS=[
                {name:'労務単価',data:['△','△','○','○','△','○','◎','◎','◎◎','◎◎','◎◎'],note:'2024 技能者日額 全国平均25,000円超（2016比+40%）'},
                {name:'鉄鋼価格（H形鋼）',data:['△','△','○','○','△','◎','◎◎','◎','◎','◎','◎'],note:'2022ピーク ¥120,000/t → 2026 ¥105,000/t（2019比+35%）'},
                {name:'生コン価格',data:['△','△','○','○','○','○','◎','◎','◎◎','◎◎','◎◎'],note:'2025 ¥18,000/m³超（2019比+30%）、骨材不足で高止まり'},
                {name:'銅価格',data:['△','○','○','△','△','◎◎','◎','◎','◎','◎','◎◎'],note:'EV需要・データセンター需要で構造的高止まり'},
                {name:'原油・エネルギー',data:['△','○','◎','○','△','◎','◎◎◎','◎','○','○','○'],note:'2022ピーク後下落も、輸送・樹脂材料費は戻らず'},
                {name:'為替（円安）',data:['—','—','—','—','—','—','◎◎','◎◎','◎◎◎','◎◎','◎◎'],note:'2022以降の円安が輸入資材全般を直撃（鋼材・銅・設備機器）'},
                {name:'建設需要指数',data:['○','○','○','○','△','○','◎','◎','◎◎','◎◎','◎◎'],note:'万博・再開発・半導体工場で需給逼迫、着工制限も'}
            ];

            // 相関係数
            function corr(x,y){
                const n=x.length;const mx=x.reduce((a,b)=>a+b)/n;const my=y.reduce((a,b)=>a+b)/n;
                let num=0,dx=0,dy=0;
                for(let i=0;i<n;i++){num+=(x[i]-mx)*(y[i]-my);dx+=(x[i]-mx)**2;dy+=(y[i]-my)**2;}
                return dx&&dy?num/Math.sqrt(dx*dy):0;
            }
            const corrRC=corr(MCI,COST.rc);
            const corrWood=corr(MCI,COST.wood);
            const corrS=corr(MCI,COST.s);
            const corrElec=corr(MCI,COST.elec);

            // 建築費要因分析
            const RONPA=[
                {claim:'労務費の上昇',reality:'労務単価は2019→2026で+40%。建築費全体の上昇寄与は約25%。為替・資材要因が合計55%を占める。',impact:'25%',data:'技能者日額 2019:¥18,000→2026:¥25,000'},
                {claim:'資材価格の高騰',reality:'鉄鋼は2022ピーク後-13%下落。銅は上昇継続だが原油は-30%。品目により上昇・下落が混在。',impact:'30%',data:'H形鋼 2022:¥120k→2026:¥105k/t（-13%）'},
                {claim:'地政学リスク・世界情勢',reality:'建築費への影響は主に原油経由（全体の15%ウェイト）。2022年以降は原油下落傾向にある。',impact:'5-8%',data:'Brent 2022:$99→2026:$69（-30%）'},
                {claim:'円安の影響',reality:'為替は建築費の最大要因で35%。ただし2024→2026は横ばい（151→153円）。上昇圧力は鈍化。',impact:'35%',data:'USD/JPY 2019:109→2022:131→2026:153'},
                {claim:'市場価格の均一化',reality:'施工会社の稼働状況により±15-20%の差が生じる。発注時期の工夫で坪10-20万のコスト差が出る。',impact:'15-20%',data:'繁忙期:3月竣工集中→1月着工が割安'},
                {claim:'仕様調整によるコスト削減',reality:'設備費比率は28%。A工事の躯体・外装で坪単価の50%以上を占め、設備削減の費用対効果は限定的。',impact:'—',data:'躯体22%+外装9%+内装12%=43%（設備より大）'}
            ];

            // ── PDF出力 ──
            const w=window.open('','_blank','width=1100,height=900');
            w.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8"><title>マクロ建築指数レポート</title><style>
                @page{size:A4 landscape;margin:12mm 10mm}
                body{font-family:'Noto Sans JP','Hiragino Sans',sans-serif;font-size:8px;color:#222;margin:0;padding:15px}
                h1{font-size:14px;font-weight:700;margin:0 0 3px;color:#1a1a1a;letter-spacing:1px}
                h2{font-size:11px;font-weight:700;margin:20px 0 6px;padding-bottom:3px;border-bottom:2px solid #1a1a1a;color:#1a1a1a}
                h3{font-size:9px;font-weight:600;margin:12px 0 4px;color:#222}
                table{border-collapse:collapse;width:100%;margin-bottom:10px;font-size:7.5px}
                th,td{border:1px solid #ccc;padding:3px 5px;text-align:center}
                th{background:#1a1a1a;color:#fff;font-weight:600;font-size:7px;letter-spacing:.5px}
                .yr{font-weight:700;background:#f5f5f3}
                .base{background:#e8e8e8;font-weight:700;border-left:2px solid #C8161D;border-right:2px solid #C8161D}
                .hi{color:#C8161D;font-weight:700}
                .lo{color:#16a34a}
                .mci-row td{background:#f0f0f0;font-weight:700;font-size:8px}
                .mci-row .hi{font-size:9px}
                .factor-hi{background:#C8161D;color:#fff;font-weight:700;padding:1px 4px;border-radius:2px;font-size:6.5px}
                .factor-mid{background:#f59e0b;color:#fff;font-weight:600;padding:1px 4px;border-radius:2px;font-size:6.5px}
                .factor-lo{color:#444;font-size:6.5px}
                .corr-badge{display:inline-block;padding:2px 8px;border-radius:10px;font-weight:700;font-size:8px;color:#fff}
                .corp-header{display:flex;justify-content:space-between;align-items:flex-end;border-bottom:3px solid #1a1a1a;padding-bottom:8px;margin-bottom:10px}
                .corp-logo{font-size:9px;font-weight:600;letter-spacing:1px;color:#1a1a1a}
                .corp-sub{font-size:7px;color:#333;margin-top:1px}
                .disclaimer{font-size:6.5px;color:#333;margin-top:6px;padding-top:4px;border-top:1px solid #ddd;line-height:1.5}
                .page-break{page-break-before:always}
                .claim{background:#f8f8f8;padding:4px 6px;font-weight:600;font-size:7.5px}
                .reality{font-size:7px;line-height:1.5}
                .impact-badge{background:#C8161D;color:#fff;font-weight:700;padding:1px 6px;border-radius:2px;font-size:7px}
                tr:nth-child(even){background:#fafaf9}
                @media print{body{padding:0}.page-break{page-break-before:always}}
            </style></head><body>`);

            // ── ヘッダー ──
            w.document.write(`<div class="corp-header">
                <div><h1>MACRO CONSTRUCTION INDEX REPORT</h1><div class="corp-sub">当社マクロ建築指数 ─ 過去10年推移分析</div></div>
                <div style="text-align:right"><div class="corp-logo">${corpName}</div><div class="corp-sub">${corpAddr}</div><div class="corp-sub">mail：${corpMail}</div><div class="corp-sub" style="margin-top:2px">作成日: ${today}　基準年: 2019（＝1.000）</div></div>
            </div>`);

            // ══ SHEET 1: マクロ指数推移 ══
            w.document.write(`<h2>Sheet 1 ─ マクロ指標＋MCI指数推移</h2>`);
            w.document.write(`<p style="font-size:7px;color:#222;margin:0 0 6px">当社では過去10年間の為替・資源・金利・株価等のマクロ指標を基に独自の建築指数（MCI）を算出しています。建築費は感覚的に上昇するのではなく、明確な経済要因と連動しています。</p>
            <p style="font-size:7px;color:#222;margin:0 0 6px"><span style="display:inline-block;background:#C8161D;color:#fff;padding:0 4px;font-size:6px;font-weight:700;margin-right:3px">◀ 基準年</span>= 2019年（MCI＝1.000）。各指標はこの年を基準に変化率を算出。<span style="display:inline-block;border-left:2px solid #C8161D;border-right:2px solid #C8161D;background:#e8e8e8;padding:0 4px;font-size:6px;margin-left:6px">グレー列</span>= 基準年データ</p>`);
            w.document.write(`<table><thead><tr><th style="width:120px">指標</th>`);
            YEARS.forEach((y,i)=>w.document.write(`<th ${i===BASE_YR?'style="background:#C8161D;color:#fff;font-size:8px"':''} class="${i===BASE_YR?'base':''}">${y}${i===BASE_YR?'<br>◀ 基準年':''}</th>`));
            w.document.write(`</tr></thead><tbody>`);
            // 5 indicators
            const rows=[
                {label:'USD/JPY（年平均）',key:'usdjpy',fmt:v=>v.toFixed(1)},
                {label:'銅 $/lb（年平均）',key:'copper',fmt:v=>v.toFixed(2)},
                {label:'原油 Brent $/bbl',key:'brent',fmt:v=>v.toFixed(1)},
                {label:'日経平均（年平均）',key:'nikkei',fmt:v=>Math.round(v).toLocaleString()},
                {label:'JGB 10Y（年平均%）',key:'jgb10y',fmt:v=>v.toFixed(2)+'%'}
            ];
            rows.forEach(r=>{
                w.document.write(`<tr><td style="text-align:left;font-weight:600">${r.label}</td>`);
                D[r.key].forEach((v,i)=>{
                    const cls=i===BASE_YR?'base':'';
                    w.document.write(`<td class="${cls}">${r.fmt(v)}</td>`);
                });
                w.document.write(`</tr>`);
            });
            // MCI row
            w.document.write(`<tr class="mci-row"><td style="text-align:left">📊 MCI（当社指数）</td>`);
            MCI.forEach((v,i)=>{
                const pct=((v-1)*100);
                const cls=i===BASE_YR?'base':(pct>5?'hi':(pct<-2?'lo':''));
                w.document.write(`<td class="${cls}">${v.toFixed(3)}${i!==BASE_YR?' <span style=\"font-size:6px\">('+((pct>=0?'+':'')+pct.toFixed(1))+'%)</span>':''}</td>`);
            });
            w.document.write(`</tr>`);
            // Separator
            w.document.write(`<tr><td colspan="${YEARS.length+1}" style="background:#1a1a1a;color:#fff;font-weight:600;text-align:left;font-size:7px">▼ 実勢建築単価推移（坪万円・概算）</td></tr>`);
            // Construction costs
            [{label:'RC造 坪単価（万円）',d:COST.rc},{label:'S造 坪単価（万円）',d:COST.s},{label:'木造 坪単価（万円）',d:COST.wood}].forEach(r=>{
                w.document.write(`<tr><td style="text-align:left;font-weight:600">${r.label}</td>`);
                r.d.forEach((v,i)=>{
                    const pct=((v/r.d[BASE_YR]-1)*100);
                    const cls=i===BASE_YR?'base':(pct>15?'hi':'');
                    w.document.write(`<td class="${cls}">${v}${i>BASE_YR?' <span style=\"font-size:6px;color:#C8161D\">(+'+pct.toFixed(0)+'%)</span>':''}</td>`);
                });
                w.document.write(`</tr>`);
            });
            [{label:'設備比率（%）',d:COST.mep},{label:'電気設備 万円/坪',d:COST.elec},{label:'空調設備 万円/坪',d:COST.hvac}].forEach(r=>{
                w.document.write(`<tr><td style="text-align:left">${r.label}</td>`);
                r.d.forEach((v,i)=>w.document.write(`<td class="${i===BASE_YR?'base':''}">${r.label.includes('%')?v+'%':v.toFixed(1)}</td>`));
                w.document.write(`</tr>`);
            });
            w.document.write(`</tbody></table>`);

            // ══ SHEET 2: 7支配要因 ══
            w.document.write(`<div class="page-break"></div>`);
            w.document.write(`<div class="corp-header">
                <div><h1>MACRO CONSTRUCTION INDEX REPORT</h1><div class="corp-sub">建築費が動く「7つの支配要因」推移</div></div>
                <div style="text-align:right"><div class="corp-logo">${corpName}</div><div class="corp-sub">${corpAddr}</div><div class="corp-sub">${today}</div></div>
            </div>`);
            w.document.write(`<h2>Sheet 2 ─ 建築費 7つの支配要因</h2>`);
            w.document.write(`<p style="font-size:7px;color:#222;margin:0 0 4px">◎◎◎＝極めて強い影響　◎◎＝強い影響　◎＝影響あり　○＝やや影響　△＝軽微　—＝影響なし</p>`);
            w.document.write(`<table><thead><tr><th style="width:130px">支配要因</th>`);
            YEARS.forEach(y=>w.document.write(`<th>${y}</th>`));
            w.document.write(`<th style="width:200px">解説</th></tr></thead><tbody>`);
            FACTORS.forEach(f=>{
                w.document.write(`<tr><td style="text-align:left;font-weight:600">${f.name}</td>`);
                f.data.forEach(v=>{
                    let cls='factor-lo';
                    if(v.includes('◎◎◎')) cls='factor-hi';
                    else if(v.includes('◎◎')) cls='factor-hi';
                    else if(v.includes('◎')) cls='factor-mid';
                    w.document.write(`<td><span class="${cls}">${v}</span></td>`);
                });
                w.document.write(`<td style="text-align:left;font-size:6.5px;color:#333">${f.note}</td></tr>`);
            });
            w.document.write(`</tbody></table>`);

            // ══ SHEET 3: 相関表 ══
            w.document.write(`<h2>Sheet 3 ─ MCI指数と実勢建築費の相関</h2>`);
            w.document.write(`<table><thead><tr><th>年</th><th>MCI指数</th><th>前年差</th><th>RC坪単価</th><th>前年差</th><th>S造坪単価</th><th>木造坪単価</th><th>設備比率</th><th>電気万円/坪</th></tr></thead><tbody>`);
            YEARS.forEach((_,i)=>{
                const mciDiff=i>0?MCI[i]-MCI[i-1]:0;
                const rcDiff=i>0?COST.rc[i]-COST.rc[i-1]:0;
                w.document.write(`<tr><td class="yr">${YEARS[i]}</td>`);
                w.document.write(`<td class="${MCI[i]>1.05?'hi':''}">${MCI[i].toFixed(3)}</td>`);
                w.document.write(`<td>${i>0?(mciDiff>=0?'+':'')+mciDiff.toFixed(3):'—'}</td>`);
                w.document.write(`<td class="${COST.rc[i]>130?'hi':''}">${COST.rc[i]}万</td>`);
                w.document.write(`<td>${i>0?(rcDiff>=0?'+':'')+rcDiff+'万':'—'}</td>`);
                w.document.write(`<td>${COST.s[i]}万</td><td>${COST.wood[i]}万</td>`);
                w.document.write(`<td>${COST.mep[i]}%</td><td>${COST.elec[i].toFixed(1)}</td>`);
                w.document.write(`</tr>`);
            });
            w.document.write(`</tbody></table>`);
            // 相関係数
            const corrColor=(v)=>v>0.9?'#16a34a':(v>0.7?'#f59e0b':'#999');
            w.document.write(`<h3>相関係数（MCI指数 vs 実勢単価）</h3>`);
            w.document.write(`<div style="display:flex;gap:15px;margin-bottom:10px">`);
            [{label:'RC坪単価',v:corrRC},{label:'S造坪単価',v:corrS},{label:'木造坪単価',v:corrWood},{label:'電気設備単価',v:corrElec}].forEach(c=>{
                w.document.write(`<div style="text-align:center"><div class="corr-badge" style="background:${corrColor(c.v)}">${c.v.toFixed(3)}</div><div style="font-size:7px;margin-top:2px;color:#222">${c.label}</div></div>`);
            });
            w.document.write(`</div>`);
            w.document.write(`<p style="font-size:7px;color:#222">相関係数0.9以上＝MCI指数と建築実勢単価は極めて高い連動性を持つ。感覚ではなくマクロ経済要因が建築費を決定していることを示す。</p>`);

            // ══ SHEET 4: 建築費要因分析 ══
            w.document.write(`<div class="page-break"></div>`);
            w.document.write(`<div class="corp-header">
                <div><h1>MACRO CONSTRUCTION INDEX REPORT</h1><div class="corp-sub">建築コスト要因分析</div></div>
                <div style="text-align:right"><div class="corp-logo">${corpName}</div><div class="corp-sub">${corpAddr}</div><div class="corp-sub">${today}｜Confidential</div></div>
            </div>`);
            w.document.write(`<h2>Sheet 4 ─ 建築コスト要因分析</h2>`);
            w.document.write(`<p style="font-size:7px;color:#222;margin:0 0 6px">建築費の上昇要因をマクロデータに基づき定量的に分解した分析シート。投資判断・事業計画の参考資料としてご活用ください。</p>`);
            w.document.write(`<table><thead><tr><th style="width:200px">コスト要因</th><th style="width:40px">影響度</th><th style="width:300px">マクロデータに基づく分析</th><th style="width:180px">根拠データ</th></tr></thead><tbody>`);
            RONPA.forEach(r=>{
                w.document.write(`<tr>`);
                w.document.write(`<td class="claim">${r.claim}</td>`);
                w.document.write(`<td><span class="impact-badge">${r.impact}</span></td>`);
                w.document.write(`<td class="reality">${r.reality}</td>`);
                w.document.write(`<td style="font-size:6.5px;color:#333">${r.data}</td>`);
                w.document.write(`</tr>`);
            });
            w.document.write(`</tbody></table>`);

            // サマリー
            w.document.write(`<h3>当社の見解</h3>`);
            w.document.write(`<div style="background:#f5f5f3;padding:8px 12px;font-size:8px;line-height:1.8;border-left:3px solid #1a1a1a">
                建築費の上昇要因は<b>為替（35%）・銅価格（25%）・労務（25%）</b>の3要素で全体の85%を説明できます。<br>
                当社MCI指数では2019年基準で<b>${((MCI[10]-1)*100).toFixed(1)}%の上昇</b>を算出しており、RC造坪単価の実勢（2019年:110万→2026年:185万、<b>+68%</b>）との相関係数は<b>${corrRC.toFixed(3)}</b>です。<br>
                一方、原油は2022年ピークから<b>30%下落</b>しており、要因ごとの動向は一様ではありません。建築費を構成する各要素の変動を把握することが、適正な事業計画の前提となります。
            </div>`);

            // フッター
            w.document.write(`<div class="disclaimer">
                本レポートは${corpName}が独自に作成した概算分析資料です。マクロ指標データはYahoo Finance等の公開情報に基づきます。建築単価は介護・医療施設（関東圏）を基準とした概算であり、地域・仕様・工期により変動します。
                本資料の数値は投資判断の参考情報であり、正式な見積り・鑑定評価ではありません。無断転載・複製を禁じます。<br>
                © ${new Date().getFullYear()} ${corpName}. All rights reserved. ─ ${corpTag}
            </div>`);

            w.document.write(`</body></html>`);
            w.document.close();
            setTimeout(()=>w.print(),500);
        }

        document.addEventListener('keydown',e=>{if(e.key==='Escape'){closePreview('bsPreview');closePreview('leasePreview')}});
        render();
    </script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="../js/auth.js"></script>
<script>requireAuth();handlePaymentSuccess();</script>
</body>
</html>
